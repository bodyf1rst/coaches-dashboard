<div class="main-dashboard-area">
  <div class="dashboard-left">
    <app-left-sidebar></app-left-sidebar>
  </div>
  <div class="dashboard-right">
    <div class="dashboard-right-head">
      <div class="dashboard-right-head-left">
        <div class="">
          <h1>Leaderboard</h1>
          <p>View top performers by body points across organizations</p>
        </div>
      </div>
      <div class="dashboard-right-head-right">
        <button class="btn btn-primary" (click)="refreshLeaderboard()" [disabled]="isLoading">
          <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
          Refresh
        </button>
        <button class="btn btn-success ms-2" (click)="exportLeaderboard()" [disabled]="leaderboardUsers.length === 0">
          <i class="fas fa-download"></i>
          Export CSV
        </button>
      </div>
    </div>

    <div class="dashboard-content">
      <!-- Organization Filter -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="form-group">
            <label for="organizationSelect" class="form-label">Select Organization:</label>
            <select 
              id="organizationSelect"
              class="form-select" 
              [(ngModel)]="selectedOrganization" 
              (change)="onOrganizationChange()"
              [disabled]="isLoading"
            >
              <option *ngFor="let org of organizations" [ngValue]="org">
                {{ org.name }}
              </option>
            </select>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group">
            <label for="maxUsersSelect" class="form-label">Show Top:</label>
            <select 
              id="maxUsersSelect"
              class="form-select" 
              [(ngModel)]="maxUsers" 
              (change)="loadLeaderboard()"
              [disabled]="isLoading"
            >
              <option [value]="10">Top 10</option>
              <option [value]="25">Top 25</option>
              <option [value]="50">Top 50</option>
              <option [value]="100">Top 100</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading leaderboard data...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !isLoading" class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
        <button class="btn btn-outline-danger btn-sm ms-2" (click)="refreshLeaderboard()">
          Try Again
        </button>
      </div>

      <!-- Leaderboard Table -->
      <div *ngIf="!isLoading && !error" class="leaderboard-container">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-trophy text-warning"></i>
              {{ selectedOrganization?.name }} Leaderboard
            </h5>
            <span class="badge bg-primary">{{ leaderboardUsers.length }} Users</span>
          </div>
          
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-dark">
                  <tr>
                    <th scope="col" class="text-center" style="width: 80px;">Rank</th>
                    <th scope="col" style="width: 80px;">Avatar</th>
                    <th scope="col">Name</th>
                    <th scope="col">Department</th>
                    <th scope="col" class="text-end">Body Points</th>
                  </tr>
                </thead>
                <tbody>
                  <tr 
                    *ngFor="let user of leaderboardUsers; trackBy: trackByUserId"
                    [class.table-warning]="user.rank === 1"
                    [class.table-info]="user.rank === 2"
                    [class.table-success]="user.rank === 3"
                  >
                    <td class="text-center align-middle">
                      <span class="rank-badge" [innerHTML]="getRankIcon(user.rank)"></span>
                    </td>
                    <td class="align-middle">
                      <img 
                        [src]="getProfileImage(user)" 
                        [alt]="user.first_name + ' ' + user.last_name"
                        class="user-avatar rounded-circle"
                        (error)="onImageError($event)"
                      />
                    </td>
                    <td class="align-middle">
                      <div class="user-name">
                        {{ user.first_name }} {{ user.last_name }}
                      </div>
                    </td>
                    <td class="align-middle">
                      <span class="badge bg-secondary" *ngIf="user.department">
                        {{ user.department }}
                      </span>
                      <span class="text-muted" *ngIf="!user.department">N/A</span>
                    </td>
                    <td class="text-end align-middle">
                      <span class="points-value">{{ formatPoints(user.body_points) }}</span>
                      <small class="text-muted d-block">points</small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="leaderboardUsers.length === 0" class="text-center py-5">
          <i class="fas fa-users fa-3x text-muted mb-3"></i>
          <h5>No Leaderboard Data</h5>
          <p class="text-muted">No users found for the selected organization.</p>
        </div>
      </div>
    </div>
  </div>
</div>
