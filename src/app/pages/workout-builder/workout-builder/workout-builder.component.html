<div class="workout-builder-container">
  <!-- Header -->
  <div class="header">
    <button class="btn-back" (click)="goBack()">
      â† Back to Plans
    </button>
    <h1 *ngIf="plan">ğŸ¯ Building Workout for: {{ plan.name }}</h1>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <p>Loading workout plan...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-message">
    <p>{{ error }}</p>
    <button (click)="loadPlan()">Retry</button>
  </div>

  <!-- Main Builder -->
  <div *ngIf="!loading && !error && plan" class="builder-main">

    <!-- Workout Configuration -->
    <div class="workout-config">
      <div class="config-row">
        <div class="config-item">
          <label>Workout Name *</label>
          <input
            type="text"
            [(ngModel)]="workoutName"
            placeholder="e.g., Full Body Strength Day 1"
            class="workout-name-input"
          />
        </div>

        <div class="config-item">
          <label>Workout Type</label>
          <select [(ngModel)]="workoutType" class="workout-type-select">
            <option *ngFor="let type of workoutTypes" [value]="type.value">
              {{ type.label }} - {{ type.description }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- CUSTOM TEMPLATE BUILDER (Only for Custom Type) -->
    <div *ngIf="workoutType === 'custom'" class="custom-template-builder">

      <!-- Add Block Menu -->
      <div class="add-block-section">
        <button class="btn-add-block" (click)="showAddBlockMenu = !showAddBlockMenu">
          <span *ngIf="!showAddBlockMenu">â• Add Template Block</span>
          <span *ngIf="showAddBlockMenu">âœ• Close Menu</span>
        </button>

        <div *ngIf="showAddBlockMenu" class="block-type-menu">
          <button class="block-type-btn emom" (click)="addTemplateBlock('emom')">
            â±ï¸ EMOM
            <span class="block-desc">Every Minute on the Minute</span>
          </button>
          <button class="block-type-btn amrap" (click)="addTemplateBlock('amrap')">
            ğŸ”¥ AMRAP
            <span class="block-desc">As Many Rounds as Possible</span>
          </button>
          <button class="block-type-btn circuit" (click)="addTemplateBlock('circuit')">
            ğŸ”„ Circuit
            <span class="block-desc">Multiple rounds of exercises</span>
          </button>
          <button class="block-type-btn tabata" (click)="addTemplateBlock('tabata')">
            âš¡ Tabata
            <span class="block-desc">High-intensity intervals</span>
          </button>
          <button class="block-type-btn traditional" (click)="addTemplateBlock('traditional')">
            ğŸ’ª Traditional
            <span class="block-desc">Standard sets & reps</span>
          </button>
          <button class="block-type-btn superset" (click)="addTemplateBlock('superset')">
            ğŸ”— Superset
            <span class="block-desc">Back-to-back exercises</span>
          </button>
          <button class="block-type-btn rest" (click)="addTemplateBlock('rest')">
            ğŸ˜Œ Rest Period
            <span class="block-desc">Recovery time</span>
          </button>
        </div>
      </div>

      <!-- Template Blocks & Video Library Side-by-Side -->
      <div class="template-panels">

        <!-- LEFT: Template Blocks -->
        <div class="template-blocks-panel">
          <div class="panel-header">
            <h2>ğŸ“‹ Template Structure</h2>
            <p class="panel-subtitle">{{ templateBlocks.length }} block{{ templateBlocks.length !== 1 ? 's' : '' }}</p>
          </div>

          <!-- Empty State -->
          <div *ngIf="templateBlocks.length === 0" class="empty-state">
            <div class="empty-icon">ğŸ¯</div>
            <h3>Start Building Your Custom Template</h3>
            <p>Click "Add Template Block" above to begin</p>
          </div>

          <!-- Template Blocks List -->
          <div class="blocks-list">
            <div
              *ngFor="let block of templateBlocks; let blockIndex = index"
              class="template-block"
              [class.expanded]="block.isExpanded"
            >
              <!-- Block Header -->
              <div class="block-header">
                <span class="block-type-badge" [class]="block.type">
                  {{ block.type.toUpperCase() }}
                </span>
                <input
                  type="text"
                  [(ngModel)]="block.name"
                  placeholder="Block name..."
                  class="block-name-input"
                />
                <div class="block-controls">
                  <button
                    class="btn-move-up"
                    (click)="moveBlockUp(blockIndex)"
                    [disabled]="blockIndex === 0"
                    title="Move up"
                  >
                    â†‘
                  </button>
                  <button
                    class="btn-move-down"
                    (click)="moveBlockDown(blockIndex)"
                    [disabled]="blockIndex === templateBlocks.length - 1"
                    title="Move down"
                  >
                    â†“
                  </button>
                  <button
                    class="btn-toggle-block"
                    (click)="toggleBlockExpanded(block)"
                    title="Expand/Collapse"
                  >
                    {{ block.isExpanded ? 'â–¼' : 'â–¶' }}
                  </button>
                  <button
                    class="btn-remove-block"
                    (click)="removeTemplateBlock(blockIndex)"
                    title="Remove block"
                  >
                    âœ•
                  </button>
                </div>
              </div>

              <!-- Block Configuration (Expanded) -->
              <div *ngIf="block.isExpanded" class="block-config">

                <!-- EMOM Configuration -->
                <div *ngIf="block.type === 'emom'" class="config-row">
                  <label>Duration (seconds)</label>
                  <input
                    type="number"
                    [(ngModel)]="block.duration"
                    min="60"
                    max="3600"
                    placeholder="600"
                  />
                  <span class="config-help">Total EMOM duration</span>
                </div>

                <!-- AMRAP Configuration -->
                <div *ngIf="block.type === 'amrap'" class="config-row">
                  <label>Duration (seconds)</label>
                  <input
                    type="number"
                    [(ngModel)]="block.duration"
                    min="60"
                    max="3600"
                    placeholder="600"
                  />
                  <span class="config-help">Time limit for AMRAP</span>
                </div>

                <!-- Circuit Configuration -->
                <div *ngIf="block.type === 'circuit'" class="config-row">
                  <label>Rounds</label>
                  <input
                    type="number"
                    [(ngModel)]="block.rounds"
                    min="1"
                    max="20"
                    placeholder="3"
                  />
                  <label>Rest Between Rounds (sec)</label>
                  <input
                    type="number"
                    [(ngModel)]="block.rest_seconds"
                    min="0"
                    max="300"
                    placeholder="60"
                  />
                </div>

                <!-- Tabata Configuration -->
                <div *ngIf="block.type === 'tabata'" class="config-row">
                  <label>Rounds</label>
                  <input
                    type="number"
                    [(ngModel)]="block.rounds"
                    min="1"
                    max="20"
                    placeholder="8"
                  />
                  <span class="config-help">Work: 20s, Rest: 10s</span>
                </div>

                <!-- Rest Period Configuration -->
                <div *ngIf="block.type === 'rest'" class="config-row">
                  <label>Rest Duration (seconds)</label>
                  <input
                    type="number"
                    [(ngModel)]="block.duration"
                    min="10"
                    max="600"
                    placeholder="60"
                  />
                </div>

                <!-- Exercises Drop Zone (Not for Rest) -->
                <div *ngIf="block.type !== 'rest'" class="block-exercises">
                  <div class="exercises-header">
                    <h4>Exercises</h4>
                    <span class="exercise-count">{{ block.exercises.length }}</span>
                  </div>

                  <!-- Drop Zone -->
                  <div
                    class="exercises-drop-zone"
                    cdkDropList
                    [id]="'block-' + blockIndex"
                    [cdkDropListData]="block.exercises"
                    [cdkDropListConnectedTo]="['videoList']"
                    (cdkDropListDropped)="dropVideoToBlock($event, blockIndex)"
                  >
                    <!-- Empty State -->
                    <div *ngIf="block.exercises.length === 0" class="drop-zone-empty">
                      <p>Drag videos here</p>
                    </div>

                    <!-- Exercise Items -->
                    <div
                      *ngFor="let exercise of block.exercises; let exerciseIndex = index"
                      class="block-exercise-item"
                      cdkDrag
                    >
                      <span class="exercise-number">{{ exerciseIndex + 1 }}</span>
                      <img
                        [src]="exercise.video?.thumbnail_url"
                        [alt]="exercise.video?.video_title"
                        class="exercise-thumb"
                        onerror="this.src='assets/images/placeholder.png'"
                      />
                      <span class="exercise-title">{{ exercise.video?.video_title }}</span>
                      <button
                        class="btn-remove-exercise"
                        (click)="removeExerciseFromBlock(blockIndex, exerciseIndex)"
                      >
                        âœ•
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Video Library (Same as Traditional) -->
        <div class="video-library-panel">
          <div class="panel-header">
            <h2>ğŸ“¹ Video Library</h2>
            <p class="panel-subtitle">Drag videos into blocks</p>
          </div>

          <!-- Search -->
          <div class="search-box">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (input)="filterVideos()"
              placeholder="ğŸ” Search videos..."
              class="search-input"
            />
          </div>

          <!-- Videos -->
          <div *ngIf="loadingVideos" class="loading-videos">
            <p>Loading videos...</p>
          </div>

          <div
            *ngIf="!loadingVideos"
            class="video-list"
            cdkDropList
            id="videoList"
            [cdkDropListData]="filteredVideos"
            [cdkDropListConnectedTo]="getDropListIds()"
          >
            <div
              *ngFor="let video of filteredVideos"
              class="video-card"
              cdkDrag
            >
              <img
                [src]="video.thumbnail_url"
                [alt]="video.video_title"
                class="video-thumbnail"
                onerror="this.src='assets/images/placeholder.png'"
              />
              <div class="video-info">
                <h4>{{ video.video_title }}</h4>
                <p class="video-meta">
                  <span *ngIf="video.muscle_groups">ğŸ’ª {{ video.muscle_groups }}</span>
                  <span *ngIf="video.workout_type">ğŸ‹ï¸ {{ video.workout_type }}</span>
                </p>
              </div>
              <div class="drag-handle" cdkDragHandle>â‹®â‹®</div>
            </div>

            <div *ngIf="filteredVideos.length === 0" class="no-videos">
              <p>No videos found</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Two Panel Layout (Traditional Types) -->
    <div *ngIf="workoutType !== 'custom'" class="builder-panels">

      <!-- LEFT PANEL: Video Library -->
      <div class="video-library-panel">
        <div class="panel-header">
          <h2>ğŸ“¹ Video Library</h2>
          <p class="panel-subtitle">Drag videos to add exercises</p>
        </div>

        <!-- Search -->
        <div class="search-box">
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (input)="filterVideos()"
            placeholder="ğŸ” Search by title, muscle group, or type..."
            class="search-input"
          />
        </div>

        <!-- Videos -->
        <div *ngIf="loadingVideos" class="loading-videos">
          <p>Loading videos...</p>
        </div>

        <div
          *ngIf="!loadingVideos"
          class="video-list"
          cdkDropList
          id="videoList"
          [cdkDropListData]="filteredVideos"
          [cdkDropListConnectedTo]="['workoutList']"
        >
          <div
            *ngFor="let video of filteredVideos"
            class="video-card"
            cdkDrag
          >
            <img
              [src]="video.thumbnail_url"
              [alt]="video.video_title"
              class="video-thumbnail"
              onerror="this.src='assets/images/placeholder.png'"
            />
            <div class="video-info">
              <h4>{{ video.video_title }}</h4>
              <p class="video-meta">
                <span *ngIf="video.muscle_groups">ğŸ’ª {{ video.muscle_groups }}</span>
                <span *ngIf="video.workout_type">ğŸ‹ï¸ {{ video.workout_type }}</span>
              </p>
            </div>
            <div class="drag-handle" cdkDragHandle>â‹®â‹®</div>
          </div>

          <div *ngIf="filteredVideos.length === 0" class="no-videos">
            <p>No videos found</p>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL: Workout Builder -->
      <div class="workout-builder-panel">
        <div class="panel-header">
          <h2>ğŸ’ª Workout Exercises</h2>
          <p class="panel-subtitle">
            {{ workoutExercises.length }} exercise{{ workoutExercises.length !== 1 ? 's' : '' }}
          </p>
        </div>

        <!-- Drop Zone -->
        <div
          class="exercise-list"
          cdkDropList
          id="workoutList"
          [cdkDropListData]="workoutExercises"
          [cdkDropListConnectedTo]="['videoList']"
          (cdkDropListDropped)="dropVideo($event)"
        >
          <!-- Empty State -->
          <div *ngIf="workoutExercises.length === 0" class="empty-state">
            <div class="empty-icon">ğŸ¯</div>
            <h3>Start Building Your Workout</h3>
            <p>Drag videos from the library to add exercises</p>
          </div>

          <!-- Exercise Cards -->
          <div
            *ngFor="let exercise of workoutExercises; let i = index"
            class="exercise-card"
            cdkDrag
          >
            <!-- Drag Handle & Order -->
            <div class="exercise-header">
              <div class="exercise-order" cdkDragHandle>
                <span class="drag-dots">â‹®â‹®</span>
                <span class="order-number">{{ i + 1 }}</span>
              </div>
              <h3 class="exercise-name">{{ exercise.video?.video_title }}</h3>
              <button class="btn-toggle" (click)="toggleExerciseExpanded(exercise)">
                {{ exercise.isExpanded ? 'â–¼' : 'â–¶' }}
              </button>
              <button class="btn-remove" (click)="removeExercise(i)">
                âœ•
              </button>
            </div>

            <!-- Exercise Config (Expanded) -->
            <div *ngIf="exercise.isExpanded" class="exercise-config">
              <div class="config-grid">
                <!-- Sets -->
                <div class="config-field">
                  <label>Sets</label>
                  <input
                    type="number"
                    [(ngModel)]="exercise.sets"
                    min="1"
                    max="20"
                    placeholder="3"
                  />
                </div>

                <!-- Reps -->
                <div class="config-field">
                  <label>Reps</label>
                  <input
                    type="number"
                    [(ngModel)]="exercise.reps"
                    min="1"
                    max="100"
                    placeholder="10"
                  />
                </div>

                <!-- Duration -->
                <div class="config-field">
                  <label>Duration (sec)</label>
                  <input
                    type="number"
                    [(ngModel)]="exercise.duration_seconds"
                    min="5"
                    max="600"
                    placeholder="60"
                  />
                </div>

                <!-- Rest Timer -->
                <div class="config-field rest-timer">
                  <label>
                    â±ï¸ Rest Timer (sec)
                    <span class="field-help">1-120 seconds</span>
                  </label>
                  <input
                    type="number"
                    [(ngModel)]="exercise.rest_timer_seconds"
                    min="1"
                    max="120"
                    placeholder="60"
                  />
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [(ngModel)]="exercise.timer_beep_enabled"
                    />
                    Enable beep sound
                  </label>
                </div>
              </div>

              <!-- Notes -->
              <div class="config-field full-width">
                <label>Notes (optional)</label>
                <textarea
                  [(ngModel)]="exercise.notes"
                  rows="2"
                  placeholder="e.g., Focus on form, slow tempo, use light weight..."
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-cancel" (click)="goBack()" [disabled]="saving">
        Cancel
      </button>
      <button
        class="btn-save"
        (click)="saveWorkout()"
        [disabled]="saving || workoutExercises.length === 0 || !workoutName.trim()"
      >
        <span *ngIf="!saving">ğŸ’¾ Save Workout</span>
        <span *ngIf="saving">â³ Saving...</span>
      </button>
    </div>

    <!-- Help Text -->
    <div class="help-text">
      <h3>ğŸ¯ Quick Tips:</h3>
      <ul>
        <li>âœ… Drag videos from left to right to add exercises</li>
        <li>âœ… Reorder exercises by dragging them up or down</li>
        <li>âœ… Click â–¶ to expand and configure sets, reps, rest timer</li>
        <li>âœ… Rest timer beeps when finished (1-120 seconds)</li>
        <li>âœ… Choose workout type: Traditional, EMOM, AMRAP, Circuit, Tabata, Superset, or Custom</li>
      </ul>
    </div>
  </div>
</div>
