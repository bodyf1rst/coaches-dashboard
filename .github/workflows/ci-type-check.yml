name: CI - Type Check & Build

# Run on all pushes and pull requests to catch type errors before Amplify deployment
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  type-check-and-build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: TypeScript Type Check
        run: |
          echo "ðŸ” Running TypeScript type checking..."
          npx tsc --noEmit
          echo "âœ… Type check passed!"

      - name: Lint Check
        run: |
          echo "ðŸ” Running Angular linter..."
          npm run lint
          echo "âœ… Lint check passed!"
        continue-on-error: true # Don't fail build on lint warnings

      - name: Production Build
        run: |
          echo "ðŸ—ï¸ Building Angular app in production mode..."
          npm run build --configuration production
          echo "âœ… Production build successful!"

      - name: Build Summary
        if: success()
        run: |
          echo "## âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript: âœ… No type errors" >> $GITHUB_STEP_SUMMARY
          echo "- Production Build: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Ready for Amplify deployment" >> $GITHUB_STEP_SUMMARY

      - name: Build Failure Summary
        if: failure()
        run: |
          echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "TypeScript errors or build issues detected." >> $GITHUB_STEP_SUMMARY
          echo "Fix errors before deployment to Amplify." >> $GITHUB_STEP_SUMMARY
